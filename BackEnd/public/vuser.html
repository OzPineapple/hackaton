<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Usuario</title>
</head>
<body style="background: url(imagenes/registro.png);background-size: cover;">
    <header class="abajo">
        <a href="admin.html" class="logo">TICKETMUNSTER</a>
        <nav>
            <ul>
                <li><a href="index.html">Inicio</a></li>
                <li><a href="tienda.html">Tienda</a></li>
                <li><a href="vuser.html">Mi perfil</a></li>
                <li><a href="isesion.html">Inicio de sesión</a></li>
                <li><a href="registro.html" class="registro">registrarse</a></li>
            </ul>
        </nav>
    </header>
    <section class="registro">
        <div class="re mdatos">
            <h1 class="tit">Datos del usuario</h1>
            <br><br>
            <label for="" class="refe">Nombre:</label>
            <label for="" class="dato" id="nom"></label>
            <br><br>
            <label for="" class="refe">Email:</label>
            <label for="" class="dato" id="email"></label>
            <br><br>
            <label for="" class="refe">Wallet:</label>
            <label for="" class="dato" id="wallet"></label>
            <br><br>
            <label for="" class="refe">Balance:</label>
            <label for="" class="dato" id="balance"></label>
            <br><br>
            <button class="enviar" style="font-size: 1em;padding: 10px;">Ingresar soles</button>
            <br><br><br><br>
        </div>
    </section>
    <section class="lista" style="margin-top: 30px;">
        <h1 class="tit" style="color: black;">Boletos</h1>
        
    </section>

    <script>
         async function Cliente(e){
            e.preventDefault();
            try {
                
                var resolt = await fetch("/clientes/");
                var sta = resolt.status;
                resolt = await resolt.json();
                switch (sta) {
                    case 201:
                    var nom = document.querySelector("#nom");
                    var email = document.querySelector("#email");
                    var wall = document.querySelector("#wallet");
                    var balance = document.querySelector("#balance");
                    var bal = resolt.balance;
                    bal = bal /1000000000;
                    nom.innerText = resolt.name;
                    email.innerText = resolt.mail;
                    wall.innerText = resolt.publicK;
                    balance.innerText = bal;
    
                        break;
                    case 404:
                        alert("Usuario no existe");
                        break;
                    case 500:
                        alert("Error en servidor");
                        break;
                    case 401:
                        alert("Error dde contraseña");
                        break;
                }
            } catch (error) {
                console.log("mamo");
            }
        }

        async function Boletos(e){
            e.preventDefault();
            
            var resolt = await fetch("/clientes/boletos");
            var sta = resolt.status;
            resolt = await resolt.json()
            var d = resolt[0].evento;
            let resolt2 = await fetch("/usuarios/event/" + d,{
                method: 'GET'
            });
            resolt2 = await resolt2.json();
            switch (sta) {
                case 201:
                for (let i = 0; i < resolt.length; i++) {
                var newdiv = document.createElement("div");
                newdiv.classList.add("event");
                var newh2 = document.createElement("h2");
                newh2.classList.add("even");
                newh2.textContent=resolt2[i].event;
                var newp = document.createElement("p");
                newp.classList.add("eved");
                newp.textContent= resolt2[i].data;
                var newa = document.createElement("a");
                newa.classList.add("evev");
                var f = new Date(resolt2[i].fecha).getTime();
                res= f-7200000;
                prueba=f-7000000;
                var ini = new Date();
                ini.setTime(res);
                var hoy = Date.now();
                if (hoy < f && hoy >=ini.getTime()) {
                    newa.addEventListener("click", function () {
                        
                        localStorage.setItem("txt","abc");
                        window.open("qr.html","_self");
                    })
                    newa.textContent="Generar boleto";
                } else {
                    newa.textContent="Aun no es posible generar el boleto";
                }
                newdiv.appendChild(newh2);
                newdiv.appendChild(newp);
                newdiv.appendChild(newa);
                document.querySelector(".lista").appendChild(newdiv);
                }
                    break;
                case 404:
                    alert("Usuario no existe");
                    break;
                case 500:
                    alert("Error en servidor");
                    break;
                case 401:
                    alert("Error dde contraseña");
                    break;
            }
        }
        
        window.onload = (event) => {
            Cliente(event);
            Boletos(event);
        };
        var enviar = document.querySelector(".enviar");
        enviar.addEventListener("click", async function (e) {
            e.preventDefault();
            window.open("fondos.html","_self");
        })

        
        
        
    </script>
</body>
</html> 